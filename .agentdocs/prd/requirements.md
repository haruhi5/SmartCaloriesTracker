# 核心功能需求 (Product Requirements)

| 项目       | 内容                                                     |
|----------|--------------------------------------------------------|
| **产品名称** | Smart Calories Tracker                                 |
| **版本**   | v1.0.0                                                 |
| **定位**   | 基于 AI 图像识别的智能卡路里追踪 Android 应用，支持拍照识别食物并自动计算热量 |

## 1. 项目背景与痛点

在日常饮食管理中，用户通常需要手动查找食物的卡路里信息并逐一记录，这个过程繁琐且容易出错。市面上现有的卡路里追踪应用往往：

1. **手动输入繁琐**: 用户需要逐一搜索食物名称并手动输入份量。
2. **数据不准确**: 依赖食物数据库，无法识别自制菜品或地方特色食物。
3. **缺乏智能化**: 没有利用现代 AI 技术简化用户操作。

**Smart Calories Tracker** 通过 **AI 图像识别** 解决此痛点，用户只需拍照或上传图片，应用即可自动识别食物并计算卡路里，大幅简化记录流程。

## 2. 核心特性 (Features)

### 2.1 AI 图像识别分析

* **核心机制**: 支持 GPT-4 Vision API 或本地 Gemini 模型进行图像分析。
* **智能识别**:
    * 自动识别图片中的食物类型和份量。
    * 估算每种食物的卡路里含量。
    * 返回结构化的营养信息（蛋白质、碳水化合物、脂肪等）。
* **多输入源**: 支持相机拍照和相册上传两种方式。

### 2.2 卡路里记录与追踪

* **每日记录**: 自动按日期分组记录用户摄入的所有食物及卡路里。
* **历史查看**: 支持查看历史记录，按日期/周/月统计。
* **数据可视化**: 类似 openScale 的图表展示，直观显示卡路里摄入趋势。

### 2.3 每日消耗估算

* **基础代谢率 (BMR)**: 根据用户身高、体重、年龄、性别计算。
* **活动因子**: 根据用户选择的活动水平调整 TDEE。
* **卡路里差值**: 实时显示「摄入 - 消耗」的差值，帮助用户了解热量盈亏。

### 2.4 用户档案与目标

* **用户资料**: 存储身高、体重、年龄、性别等基础信息。
* **健身目标**: 支持三种目标模式：
    * **体重维持 (Maintain)**: 摄入 ≈ TDEE
    * **增肌 (Muscle Gain)**: 摄入 > TDEE (热量盈余)
    * **减脂 (Fat Loss)**: 摄入 < TDEE (热量赤字)
* **目标进度**: 根据用户目标动态调整每日推荐摄入量。

### 2.5 数据导出

* **CSV 导出**: 支持将所有用户数据（食物记录、卡路里、日期等）导出为 CSV 文件。
* **分享功能**: 支持通过系统分享菜单导出文件。

### 2.6 原生体验 (Native Experience)

* **Design**: Material 3 + Material You 风格，类似 openScale 的简洁界面。
* **Android 适配**: 针对最新 Android API 进行优化。
* **无广告/轻量级**: 专注于核心功能，极低功耗。
* **隐私优先**: 支持本地模型，数据存储在本地。

## 3. 技术规格 (Technical Requirements)

* **Min SDK**: 26 (Android 8.0)
* **Target SDK**: 34 (Android 14)
* **架构**: MVVM + Clean Architecture
* **语言**: Kotlin
* **UI**: Jetpack Compose
* **DI**: Hilt
* **数据库**: Room
* **网络**: Retrofit + OkHttp
* **图表**: MPAndroidChart 或 Vico

## 4. 功能需求详情

| ID      | 模块         | 功能点          | 描述                                                              | 优先级 |
|:--------|:-----------|:--------------|:----------------------------------------------------------------|:-----|
| **F01** | **图像输入**   | 相机拍照         | 调用系统相机拍摄食物照片，需处理 Android 权限和 FileProvider。                      | P0   |
| **F02** | **图像输入**   | 相册上传         | 从系统相册选择已有图片进行分析。                                                | P0   |
| **F03** | **AI 分析**  | GPT API 分析   | 将图片发送至 GPT-4 Vision API 进行食物识别和卡路里估算。                          | P0   |
| **F04** | **AI 分析**  | 本地模型分析       | 集成 Gemini Nano 或其他本地 LLM，实现离线图像分析能力。                           | P1   |
| **F05** | **数据记录**   | 食物记录         | 将分析结果保存到本地 Room 数据库，包含食物名称、卡路里、时间戳等。                           | P0   |
| **F06** | **UI**     | 仪表盘首页        | 显示今日摄入总卡路里、目标进度、剩余可摄入量。                                         | P0   |
| **F07** | **UI**     | 历史记录页        | 列表展示历史食物记录，支持按日期筛选。                                             | P0   |
| **F08** | **UI**     | 数据图表         | 类似 openScale 的折线图/柱状图展示卡路里趋势。                                   | P1   |
| **F09** | **用户**     | 用户资料设置       | 输入/编辑用户身高、体重、年龄、性别等信息。                                          | P0   |
| **F10** | **用户**     | 健身目标设置       | 选择体重维持/增肌/减脂目标，系统自动计算推荐摄入量。                                     | P0   |
| **F11** | **数据**     | TDEE 计算      | 根据用户资料和活动水平计算每日消耗热量。                                            | P0   |
| **F12** | **数据**     | CSV 导出       | 将所有记录导出为 CSV 文件，支持分享。                                           | P1   |
| **F13** | **系统**     | 每日提醒通知       | 可选的每日记录提醒通知。                                                    | P2   |

## 5. 数据存储 (Room Database)

### 5.1 用户表 (User)

| 字段                | 类型      | 默认值         | 说明                                    |
|:------------------|:--------|:------------|:--------------------------------------|
| `id`              | Long    | Auto        | 主键                                    |
| `name`            | String  | ""          | 用户名称                                  |
| `height`          | Float   | 170.0       | 身高 (cm)                               |
| `weight`          | Float   | 70.0        | 体重 (kg)                               |
| `age`             | Int     | 25          | 年龄                                    |
| `gender`          | String  | "male"      | 性别 (male/female)                      |
| `activity_level`  | Int     | 2           | 活动水平 (1-5, 1=久坐, 5=高强度运动)              |
| `goal`            | String  | "maintain"  | 目标 (maintain/muscle_gain/fat_loss)    |
| `target_calories` | Int     | 2000        | 目标每日卡路里摄入                             |

### 5.2 食物记录表 (FoodEntry)

| 字段            | 类型      | 默认值  | 说明                 |
|:--------------|:--------|:-----|:-------------------|
| `id`          | Long    | Auto | 主键                 |
| `user_id`     | Long    | -    | 外键关联用户             |
| `food_name`   | String  | ""   | 食物名称               |
| `calories`    | Int     | 0    | 卡路里                |
| `protein`     | Float   | 0.0  | 蛋白质 (g)            |
| `carbs`       | Float   | 0.0  | 碳水化合物 (g)          |
| `fat`         | Float   | 0.0  | 脂肪 (g)             |
| `image_path`  | String? | null | 原始图片路径             |
| `timestamp`   | Long    | -    | 记录时间戳              |
| `meal_type`   | String  | ""   | 餐食类型 (早餐/午餐/晚餐/加餐) |

### 5.3 设置表 (DataStore)

| Key                     | 类型      | 默认值       | 说明              |
|:------------------------|:--------|:----------|:----------------|
| `key_api_type`          | String  | "gpt"     | AI 分析接口类型       |
| `key_api_key`           | String  | ""        | GPT API Key     |
| `key_local_model_path`  | String  | ""        | 本地模型路径          |
| `key_reminder_enabled`  | Boolean | false     | 记录提醒开关          |
| `key_reminder_time`     | String  | "12:00"   | 提醒时间            |
| `key_unit_system`       | String  | "metric"  | 单位制 (metric/imperial) |
| `key_theme_mode`        | String  | "system"  | 主题模式 (light/dark/system) |

## 6. 非功能性需求 (NFR)

* **隐私安全**: 
    * 支持完全离线的本地模型分析模式。
    * 用户数据仅存储在本地，不上传任何服务器。
    * API Key 使用 EncryptedSharedPreferences 加密存储。
* **性能优化**: 
    * 图片压缩后再上传 API，减少流量消耗。
    * Room 数据库查询使用分页加载。
* **用户体验**:
    * 分析过程显示 Loading 动画和进度提示。
    * 支持手动修正 AI 识别结果。
